# RandomRuslan_infra
RandomRuslan Infra repository


# 5. Облачная инфраструктура
## SSH
Для подключения к внутреннему серверу через внешний в одну строку необходимо использовать `ProxyJump`:
```shell
ssh -i ~/.ssh/appuser -J <BASTION_USER>@<BASTION_SERVER> <INTERNAL_USER>@<INTERNAL_SERVER>
```

Сокращаем до вида `ssh someinternalhost`:
 - Создаем конфиг файл `~/.ssh/config`
 - Заполняем следующим кодом:
```shell
Host someinternalhost
  HostName <INTERNAL_SERVER>
  User <INTERNAL_USER>
  IdentityFile <PATH_TO_PRIVATE_KEY>
  ProxyJump <BASTION_USER>@<BASTION_SERVER>
```

Чтобы после этого подключаться исключительно по алиасу `someinternalhost`, необходимо:
 - Добавить в файл `~/.zshrc` (для OS X) добавить строку `alias someinternalhost="ssh someinternalhost"`
 - Выполнить `source ~/.zshrc`

## VPN-сервер

Домен по https:
```shell
https://84-252-139-85.sslip.io/
```

Данные для проверки:
```shell
bastion_IP = 84.252.139.85
someinternalhost_IP = 10.129.0.26
```

# 6. Основные сервисы Yandex Cloud

Команда создания инстанса:
```shell
yc compute instance create \
 --name reddit-app \
 --hostname reddit-app \
 --memory=4 \
 --create-boot-disk image-folder-id=standard-images,image-family=ubuntu-1604-lts,size=10GB \
 --network-interface subnet-name=default-ru-central1-a,nat-ip-version=ipv4 \
 --metadata serial-port-enable=1 \
 --ssh-key ~/.ssh/appuser.pub \
 --zone ru-central1-a
```

Скрипты для запуска приложения:
 - install_ruby.sh
 - install_mongodb.sh
 - deploy.sh

Данные для проверки:
```shell
testapp_IP = 51.250.88.98
testapp_port = 9292
```

Для проверки необходимо открыть сайт `http://51.250.88.98:9292/`

# 7. Packer

Написан скрипт `config-scripts/create-reddit-vm.sh`, который создает сервисный аккаунт, bake-образ ВМ и саму ВМ.
При создании ВМ запускается reddit-приложение.

Для запуска необходимо из корня проекта запустить скрипт `./config-scripts/create-reddit-vm.sh`

Для проверки необходимо открыть сайт `http://51.250.94.99:9292/`

# 8. Terraform 1

Выполнение основного задания:
1. Создал новый аккаунт для работы с terraform (reddit-terraform)
2. Скачал файл провайдера yandex, потому что мы за железным занавесом
3. Написал конфиги для деплоя сервера на основе образа, собранного packer
4. Установил переменные:
   - export TF_VAR_service_account_key_file=.../key-terraform.json
   - zone - значение по умолчанию
   - остальные - в файле terraform.tfvars
5. Запустил сборку, получил работающий сервер с запущенным приложением
6. Получил на вывод внешний ip сервера

## Дополнительное задание

1. Сделал второй интсанс реддит приложения путем копирования и небольшого редактирования первого
2. Написал балансер (lb.tf), который редиректит на работающее приложение
3. При отключении одного из приложений, по адресу балансера работает второе приложение

Проблемы создания двух одинаковых приложений дублированием описания инстанса:
- В N раз больше кода
- Нужно поправить все описания xxx1 -> xxx2, что можно пропустить (я пропустил)
- При изменении инстанса, это нужно сделать N раз

4. Ввел переменную app_count - кол-во поднимаемых инстансов
5. Переписал балансер на работу с app_count инстансов

# 9. Terraform 2

1. Создал ресурс IP адреса, использовал его в качестве subnet_id
2. Разбил бд и приложение на разные инстансы ВМ
3. Разбил создание инстансов и vpc на модули
4. Инициировал терраформ с модулями командой `terraform get`
5. Использовал модули для отдельной сборки стейдж и прод приложения

# 10. Ansible 1

1. Установил Ansible
2. Написал inventory-файлы в различных форматах (ini, yaml, json)
3. Сконфигурировал Ansible
4. Поигрался с различными модулями
5. Написал плейбук для установки git и клонирования reddit-репозитория
6. Написал скрипт, который генерирует JSON-инвентори с актуальными ip инстансов терраформа

## Ответы

### Различия выводов при повторении выполнения плейбука

При запуске плейбука, успешное выполнение таска может быть зеленого и желтого цветов.
Желтый - произведены какие-то изменения (changed>0), зеленый - нет (changed=0).

### Отличия схем JSON динамического и статического инвентори

Различие в значении hosts:
- Статический - подробное описание каждого хоста в группе с его алиасом (нпрм, appserver)
- Динамический - список хостов (т.е. ["host1.example", "host2.example", "192.0.0.1"])

## Работа с динамическим инвентори

1. Написал bash-скрипт, который парсит output-переменные терраформа и заворачивает их в требуемый JSON формат
2. Назвал этот скрипт inventory.json, сделал файл исполняемым
3. Добавил в ansible.cfg строку `inventory = ./inventory.json`
4. При выполнении ansible-команд, вызывается скрипт, который генерирует JSON с актуальными ip инстансов

# 11. Ansible 2

1. Написал один плейбук для всех инстансов с разбивкой по тегам (reddit_app_one_play.yml).
2. Разбил плейбук на три сценария: конфигурации бд и приложения, деплой приложения (reddit_app_multiple_plays.yml).
3. Разбил три сценария на три плейбука. Объединил их импорты в новом плейбуке (site.yml).
4. Сделал создание образов с помощью плейбуков (packer_app.yml, packer_db.yml).

# 12. Ansible 3

1. Разбил логику на роли: app, db
2. Сделал два окружения: stage, prod
3. Добавил nginx-роль для работы приложения на 80 порту
